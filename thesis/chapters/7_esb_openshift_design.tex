\chapter{Design ESB in Openshift}
\label{cha:esboc}
As discussed in Chapter \vref{cha:esb}, an ESB is a distributed computing architecture, where distributed services act as a consumer or producer. These integration services provide a business value for an enterprise in form of an integration of an internal or external service. There are multiple providers of ESB middleware like JBoss Fuse, which provide tooling for implementing Service Components running on an ESB. It should be possible to migrate such a Service Component to a microservice, where features provided by the ESB middleware such as mediation and bindings will have to be replaced by other implementations.
\\ \\
In this chapter, the ESB integration as discussed in Section \vref{sec:esb-integration-example} and illustrated in Figure \vref{fig:esb-design-sca}, will be implemented as microservices, which will be hosted within an Openshift Project. The hosting Openshift Project will represent the ESB, which provides orchestration, mediation, configurations and secrets for the hosted integration services. The concrete functionality of the services is considered not to be important. More important is how to design and implemented the integration of the microservices, which represent the Service Component, and how to run them on a Openshift Cluster.

\section{Microservice Architecture}
Figure \vref{fig:esboc-design-services} illustrates the microservice architecture of the integration prototype, based on the architecture of Figure \vref{fig:esb-design-sca}. Conceptually, the transformation of a Service Component to a microservice is easy, because a Service Component and a microservice act very similar. Compared to a Service Component of a ESB middleware, a microservice is completely separated from the other services, brings in its own dependencies and runs in its own runtime environment. From the implementation point of view, the microservice needs to provide an runtime environment, which formerly was provided by the ESB middleware. Therefore, that the microservices are completely separated, the access of other services is not mediated as usual anymore, because the communication is now performed via standard protocols like HTTP(S). In a monolithic ESB application running on EAP, every Service Component accessed via a Reference uses the actual service instance within the same runtime environment. With microservices, running in their own runtime environment, it is not possible to access the service instance directly anymore. Only communication via standard protocols such as HTTP(S) is supported.

\begin{figure}[htbp]
	\centering
	\includegraphics[scale=1]{images/esboc-design-microservice.pdf}
	\caption{Microservice Architecture}
	\label{fig:esboc-design-services}
\end{figure}

\section{Microservice Aspects}
\label{sec:esboc-aspects}
In this section the necessary aspects of microservices are discussed, which will ensure that the integration services are properly implemented and can effortlessly be managed. Especially the monitoring of the integration services becomes very important when moving from a conventional monolithic ESB application, like an application running on JBoss Fuse, to microservice based integration services. Integration services running as microservices on Openshift, are running in their and therefore cannot share any runtime resources, which are available in a monolithic application. 
\\ \\
Figure \vref{fig:esboc-aspects} illustrates the hierarchy of the microservice aspects, which are discussed in the following sections. The in the following discussed microservice aspects shall ensure that the microservices are 
\begin{itemize}
	\item secure,
	\item configurable for multiple environments,
	\item observable by developers and operators,
	\item resilient to failures
	\item and measurable.
\end{itemize}

\begin{figure}[htbp]
	\centering
	\includegraphics[scale=1]{images/esboc-requirement-services.pdf}
	\caption{Service Requirements}
	\label{fig:esboc-aspects}
\end{figure} 

\subsection{Security}
\label{sec:esboc-aspects-security}
Distributed microservices need to be secured properly from unauthorized access, therefore the microservices will be secured with OAuth. OAuth is a token based authentication scheme, which has become popular over past few years. The Integration Microservice must authenticate its client, the Application Service against an central authentication service, whereby the Application Service will retrieve the access tokens from the central authentication service \cite{OAuth2018}.

\subsection{Configuration}
\label{sec:esboc-aspects-config}
The MicroProfile specifications provide the MicroProfile-Config specification, which provides an API to inject configuration parameters into objects. The injected configuration parameters are loaded from so called configuration sources. The microservices must provide the possibility to be configurable for different stages such as DEV (development), TEST (testing) and PROD (productive environment), whereby  the services are only allowed to use configuration parameters via injection  \cite{EclipseMicroprofileConfig2018}.

\subsection{Tracing}
\label{sec:esboc-aspects-tracing}
Distributed Tracing allows to comprehend service or method call chains. The MicroProfile specifications provides the OpenTracing specification, which provides an API for tracing an application on a method level or across service boundaries. The services must be able to collect tracing information and send this data to a central tracing service \cite{CNCFOpentracing2018}.

\subsection{Logging}
\label{sec:esboc-aspects-logging}
Distributed Logging allows to comprehend logs across service boundaries within a service call chain, where the logs of a service call chain have to be marked with a transaction id. The services must be able to provide all of their logging to a central service, whereby the logs are marked with a transaction id, which is provided by the OpenTracing API. Optionally, the services are allowed to add additional markers, which can help developers and operators to analyze problems or to group service logs.

\subsection{Metrics}
\label{sec:esboc-aspects-metrics}
The MicroProfile specifications provide the specification MicroProfile-Metric, which provides an API to define and manage metrics. Metrics allow to comprehend the state of a microservice such as resource consumption, REST-API calls or Failure counts. Metrics along with tracing and distributed logging, provide the necessary data operators need to analyze failures in services or service call chains. The services must provide and publish metrics, which can be made available to a central metric service.

\subsection{Fault Tolerance}
\label{sec:esboc-requirements-service-fault}
The MicroProfile specifications provide the specification MicroProfile-Fault-Tolerance, which provides an API to define fault tolerance behavior such as retries, timeouts and error fall-backs. The fault tolerance of a service means that, if a depending service is not accessible at the time, a service must not fail immediately after the first try, but the service should retry to call the depending service for several times, and fail when all retries have failed. Such a behavior ensures that short timed communication errors, redeployments or overloads do not immediately cause a service to fail. The services must provide proper fault tolerance configuration and fall-back behavior to be able to recover from such errors in a proper manner. \cite{EclipseMicroprofileFault2018}.   

\subsection{API Management}
\label{sec:esboc-requirements-service-api}
The API management of a public API such as REST-API and REST-Models ensure that the clients, using a public API, are not broken by changes made on that API. There are several opinions on how API management can be done. Swagger has become very popular for documenting REST-API, where the documentation can be used to generate clients, provide documentation for developers and to test the public API. The services must be capable of migrating their public API in a way that the clients are not broken by made changes \cite{SmartBearSwagger2018}.

\textbf{ADD resource which christoph found during liwestfsw research} 
\newpage
\section{Openshift Architecture}
\label{sec:esboc-design-oc}
Figure \vref{fig:esboc-design-openshift-project} illustrates the structure of the Openshift Project, as well as the service dependencies within the Openshift Project. As discussed in Section \vref{sec:paas-openshift}, Openshift isolates the namespaces, by bringing in the concept of an Openshift Project. Services hosted in an Openshift Project which are not exposed via an Openshift Route, are implicitly protected from external access from the Internet or services hosted in other Openshift Projects. The Openshift Project will contain the Application Service, the Database Service and the Integration Service. The Application Service has access to the Internet and will be accessed by the Client from the Internet via its public address. The Integration Service and the Database Service are not exposed to the Internet and can only be accessed within the Openshift Project by their service names.

\begin{figure}[htbp]
	\centering
	\includegraphics[scale=1]{images/esboc-design-openshift.pdf}
	\caption{Openshift Project architecture}
	\label{fig:esboc-design-openshift-project}
\end{figure} 

\section{Openshift Requirements}
\label{sec:esboc-requirements-oc}
The implementation of the Openshift resources such as templates and scripts must be implemented under consideration of the principles of IaC, as discussed in Section \vref{sec:iac-principles}. Keeping to the principles of IaC will ensure, that the Openshift Project can effortlessly be reproduced with a different configuration.  
\\ \\
The Openshift Project will host the integration services and manage their configuration and secrets via Openshift ConfigMaps and Openshift Secrets, which have been discussed in Section \vref{sec:caas-kubernetes-objects}. The configurations and secrets are managed outside the microservice code bases and are provided by the hosting Openshift Project for a specific stage the Openshift Project represents. The configurations and secrets are supposed to be managed by operators and are only made available to the services during runtime.
\\ \\
The implemented microservices shall manage their integration into Openshift, by providing the necessary templates, whereby configurations and secrets are accessed by their predefined names and keys. The Openshift Project provides the referenced resource such as configurations and secrets. Configurations and secrets are managed on a single location by trusted persons, without the need of a developer to access secrets. 
\\ \\
Along with the integration services, the Openshift Project shall host a Tracing Service and a Logging Service as well, which collect the tracing and logging data provided by the integration services. These service will be used to monitor the integration services.
